<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>QuakeMap</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(to bottom, #6eb4e4, #274278);
        }
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: none;
        }
        .quake-alert {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #003C8F;
            color: yellow;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 36px;
            font-weight: bold;
            z-index: 1000;
        }
        .quake-alert span {
            color: white;
            margin-left: 10px;
            font-size: 36px;
        }
        .fade-in-out {
            animation: fadeInOut 2.2s infinite;
        }
        @keyframes fadeInOut {
            0% { opacity: 1; }
            90.91% { opacity: 0; }
            100% { opacity: 0; }
        }
        .control-buttons {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 1000;
        }
        .quake-info-list {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            width: 200px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            z-index: 1000;
            margin-bottom: 10px;
            position: absolute;
            bottom: 10px;
            right: 150px;
        }
        .control-buttons button {
            background-color: rgba(0, 0, 139, 0.8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 120px;
            text-align: center;
            margin-top: 10px;
        }
        .control-buttons button:hover {
            background-color: rgba(0, 0, 139, 1);
        }
        .version-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 10px;
            text-align: center;
            margin-top: 5px;
            z-index: 1000;
        }
        .info-box {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 20px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.5;
            z-index: 1000;
        }
        .info-box span {
            color: yellow;
        }
        .quake-info-list .quake-item {
            padding: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .quake-info-list .quake-item:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .quake-info-list .quake-item.selected {
            color: red;
            font-weight: bold;
        }
        .intensity-info {
            position: absolute;
            top: 90px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.5;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="quake-alert">
        地震発生 <span id="quake-time">-時-分</span>
    </div>
    <div class="info-box" id="info-box">【震度 undefined】<br>null</div>
    <div class="quake-info-list" id="quake-info-list"></div>
    <div class="control-buttons">
        <button id="toggleQuakeList">確定震度</button>
        <button id="showAll">全国表示</button>
        <button id="focusOnPlot">プロット中心</button>
        <button id="focusOnQuake">震源地中心</button>
    </div>
    <div class="intensity-info" id="intensity-info"></div>
    <div class="version-info">
        Shindo QuakeMap Version0.91 ｜ 
        <a href="https://p2pquake.net" style="color: white;">P2P地震情報</a> ｜ 
        <a href="https://www.jma.go.jp" style="color: white;">気象庁</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var JMAPoints = {
            "points": [
                { "name": "Tokyo", "code": "101" },
                { "name": "Osaka", "code": "102" }
            ]
        };

        var map = L.map('map', {
            zoomControl: false
        }).setView([35.6895, 139.6917], 5);

        var prefecturesLayer = L.geoJSON(null, {
            style: {
                color: "#000000",
                weight: 1.5,
                opacity: 1,
                fillColor: "#ffffff",
                fillOpacity: 1
            }
        });
        var cartoLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {opacity: 0.7});
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {opacity: 0.7});
        var opentopoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {opacity: 0.7});

        fetch('prefectures.geojson')
            .then(response => response.json())
            .then(data => {
                prefecturesLayer.addData(data);
                prefecturesLayer.addTo(map);
            })
            .catch(error => console.error('GeoJSONデータの読み込みに失敗しました:', error));

        var shindoIcons = {
            "10": L.icon({iconUrl: 'ShindoImg/1.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "20": L.icon({iconUrl: 'ShindoImg/2.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "30": L.icon({iconUrl: 'ShindoImg/3.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "40": L.icon({iconUrl: 'ShindoImg/4.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "45": L.icon({iconUrl: 'ShindoImg/5-.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "50": L.icon({iconUrl: 'ShindoImg/5+.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "55": L.icon({iconUrl: 'ShindoImg/6-.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "60": L.icon({iconUrl: 'ShindoImg/6+.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "70": L.icon({iconUrl: 'ShindoImg/7.png', iconSize: [25, 41], iconAnchor: [12, 41]}),
            "ep": L.icon({iconUrl: 'ShindoImg/ep.png', iconSize: [41, 41], iconAnchor: [20, 20]})
        };

        var quakeMarker = L.marker([0, 0], { icon: shindoIcons["ep"] }).addTo(map);
        var observationMarkers = {};
        var selectedQuake = null;

        async function fetchObservationPoints() {
            try {
                const response = await fetch('https://api.p2pquake.net/v2/history?codes=551');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log("取得したデータ:", data);

                if (data.length === 0) {
                    console.warn("データがありません");
                    return;
                }

                const quakeInfoList = document.getElementById('quake-info-list');
                quakeInfoList.innerHTML = '';

                data.forEach(quake => {
                    if (quake.earthquake && quake.earthquake.hypocenter && quake.earthquake.maxScale) {
                        const quakeTime = new Date(quake.earthquake.time);
                        const quakeTimeString = `${quakeTime.getHours().toString().padStart(2, '0')}:${quakeTime.getMinutes().toString().padStart(2, '0')} ${formatScale(quake.earthquake.maxScale)}震度`;

                        const quakeItem = document.createElement('div');
                        quakeItem.className = 'quake-item';
                        quakeItem.textContent = quakeTimeString;
                        quakeItem.dataset.quake = JSON.stringify(quake);
                        quakeItem.addEventListener('click', function() {
                            selectQuake(this, quake);
                        });
                        quakeInfoList.appendChild(quakeItem);
                    }
                });

                if (quakeInfoList.children.length > 0) {
                    quakeInfoList.children[0].click();
                }

            } catch (error) {
                console.error("データの取得に失敗しました:", error);
            }
        }

        function selectQuake(quakeElement, quake) {
            if (selectedQuake) {
                selectedQuake.classList.remove('selected');
            }
            selectedQuake = quakeElement;
            selectedQuake.classList.add('selected');

            const earthquake = quake.earthquake;
            const quakeTime = earthquake.time;
            updateQuakeTime(quakeTime);

            const quakeLatLng = [earthquake.hypocenter.latitude, earthquake.hypocenter.longitude];
            const quakeInfoBox = document.getElementById('info-box');
            quakeInfoBox.innerHTML = `
                震源 ${earthquake.hypocenter.name || '不明'}<br>
                深さ ${earthquake.hypocenter.depth === -1 ? '不明' : earthquake.hypocenter.depth + 'km'}<br>
                規模 ${formatMagnitude(earthquake.hypocenter.magnitude)}<br>
                <span>${getTsunamiInfo(earthquake.domesticTsunami)}</span>
            `;

            quakeMarker.setLatLng(quakeLatLng);
            quakeMarker._icon.classList.add('fade-in-out');

            const observationPoints = quake.points;
            plotObservationPoints(observationPoints);
        }

        function updateQuakeTime(quakeTime) {
            const date = new Date(quakeTime);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const formattedTime = `${hours}時${minutes}分`;
            document.getElementById('quake-time').innerText = formattedTime;
        }

        function formatMagnitude(magnitude) {
            return magnitude === -1 ? '不明' : 'M' + magnitude.toFixed(1);
        }

        function formatScale(scale) {
            const scaleMapping = {
                "10": "1",
                "20": "2",
                "30": "3",
                "40": "4",
                "45": "5弱",
                "50": "5強",
                "55": "6弱",
                "60": "6強",
                "70": "7"
            };
            return scaleMapping[scale] || '不明';
        }

        function getTsunamiInfo(domesticTsunami) {
            switch (domesticTsunami) {
                case 'None': return '津波の心配なし';
                case 'Unknown': return '津波不明';
                case 'Checking': return '津波調査中';
                case 'NonEffective': return '若干の海面変動あり';
                case 'Watch': return '津波注意報';
                case 'Warning': return '津波警報';
                default: return '不明';
            }
        }

        function plotObservationPoints(observationPoints) {
            Object.values(observationMarkers).forEach(marker => {
                map.removeLayer(marker);
            });

            observationMarkers = {};

            const intensityInfo = document.getElementById('intensity-info');
            intensityInfo.innerHTML = '';

            observationPoints.forEach(point => {
                const { name, code, latitude, longitude, scale } = point;
                if (latitude !== undefined && longitude !== undefined && scale !== undefined) {
                    const latLng = [latitude, longitude];
                    const icon = shindoIcons[scale] || shindoIcons["10"];
                    const marker = L.marker(latLng, { icon }).addTo(map);
                    observationMarkers[code] = marker;

                    const scaleText = formatScale(scale);
                    const infoText = `【${scaleText}】<br>${name}`;
                    const infoItem = document.createElement('div');
                    infoItem.innerHTML = infoText;
                    intensityInfo.appendChild(infoItem);
                }
            });
        }

        document.getElementById('toggleQuakeList').addEventListener('click', function() {
            const quakeInfoList = document.getElementById('quake-info-list');
            if (quakeInfoList.style.display === 'none') {
                quakeInfoList.style.display = 'block';
            } else {
                quakeInfoList.style.display = 'none';
            }
        });

        document.getElementById('showAll').addEventListener('click', function() {
            map.setView([35.6895, 139.6917], 5);
        });

        document.getElementById('focusOnPlot').addEventListener('click', function() {
            if (Object.values(observationMarkers).length > 0) {
                const bounds = L.latLngBounds(Object.values(observationMarkers).map(marker => marker.getLatLng()));
                map.fitBounds(bounds);
            }
        });

        document.getElementById('focusOnQuake').addEventListener('click', function() {
            map.setView(quakeMarker.getLatLng(), 8);
        });

        fetchObservationPoints();
    </script>
</body>
</html>
